<!DOCTYPE html>
<html>
	<head>
		<title>GarlicTrader</title>
		<link rel="stylesheet" href="resc/style.css">
		<link rel="icon" href="images/logo.png">

		<script>
			// Here is where I will set up all API's I need.

			var satoshiPrice;
			var bitcoinFloat;
			var priceInUSD;
			var bankBalance;
			var transaction;

			const tradeSatoshiApi = "https://cors.io/?https://tradesatoshi.com/api/public/getmarkethistory?market=GRLC_BTC&count=1";
			const coindeskApi = "https://api.coindesk.com/v1/bpi/currentprice.json";
			const currentBankBalance = "https://cors.io/?http://explorer.grlc-bakery.fun/ext/getbalance/Gdhuz25VxxA5uLjF9S8u62KN4Gt8HjjcAs";
			const checkTransactionID = "https://cors.io/?https://explorer.grlc-bakery.fun/api/getrawtransaction?txid=";

			fetch(tradeSatoshiApi, {
				method: 'get'
			}).then(function(satoshiResponse) {
				console.log('%c Was able to reach TradeSatoshi API ', 'color: green;') // Able to connect to Satoshi.

				// I am now going to get a response in JSON and work with it.

				return satoshiResponse.json(); // This is all this handles. Now for the next part.
			}).then(function(satoshiResponseJSON) {
				// Now our JSON response is a JS object. Now I can mess with it and set it's values.
				console.log(satoshiResponseJSON); // Log it.
				var stringSatoshiJSON = JSON.stringify(satoshiResponseJSON);
				console.log(stringSatoshiJSON);

				// For some reason I can't get stuff from this JSON array so I have to do it manually lol.

				var isolatedStringSetOne = stringSatoshiJSON.slice(stringSatoshiJSON.indexOf('price":') + 'price":'.length); // Isolate part of our string.
				
				satoshiPrice = isolatedStringSetOne.split(',')[0]
				console.log(satoshiPrice);

				// Yay! Price is now done.

			}).catch(function() {
				console.log('%c Error! Could not reach TradeSatoshi. ', 'color: red;');

				document.getElementById("garlicPrice").innerHTML = "Internal error. Please reload.";
			})

			// Time to get a conversion from BTC to USD.

			fetch(coindeskApi, {
				method: 'get'
			}).then(function(coindeskResponse) {
				console.log('%c Was able to reach Coindesk API ', 'color: green;')

				return coindeskResponse.json();

				setTimeout(coindeskResponseJSON)
			}).then(function(coindeskResponseJSON) {
				// Setting our variables,

				bitcoinFloat = coindeskResponseJSON.bpi.USD.rate_float;
				console.log("Current BTC price = " + bitcoinFloat + ".");
			})

			function setPrices() {

				// Set prices sets the BTC to USD price and also the bank prices.

				setTimeout(function() {
					var priceInUSD = satoshiPrice * bitcoinFloat;
					console.log(priceInUSD + " per coin.");

					priceInUSD = priceInUSD.toString(); // Because substring only works on strings.

					priceInUSD = priceInUSD.substring(0,4);
					document.getElementById("garlicPrice").innerHTML = "Current price = ~$" + priceInUSD + " per coin.";
				}, 2000)

				fetch(currentBankBalance, {
					method: 'get'
				}).then(function(gettingBankBalance) {
					console.log('%c Was able to access the explorer. ', 'color: green;')

					return gettingBankBalance.json();
				}).then(function(bankBalaceResponse) {
					// Set bank variables.

					bankBalance = bankBalaceResponse;
					console.log("Explorer says the bank has " + bankBalance + " coins.");

					document.getElementById("bankBalance").innerHTML = "Current store balance: " + bankBalance + " coins";

					console.log('%c GarlicTrader is all setup! Everything should work as described and all endpoints are working. ', 'color: green;')
				}).catch(function(catchBankBalance) {
					console.log('%c The Explorer API is not working. Please refresh or check API checkpoints. ', 'color: red;')

					document.getElementById("bankBalance").innerHTML = "Internal error. Please refresh.";
				})
			}

			function buyClicked() {
				console.log('%c The buy button was clicked. Could not generate receipt. ', 'color: red;')
			}

			function sellClicked() {
				console.log('%c The sell button was clicked. Generating receipt. ', 'color: red;')
				document.getElementById("sellLogo").innerHTML = "Verifying info with blockchain...";

				var coinAmmountSent = document.getElementById("coinAmmountSent").value;
				var transactionID = document.getElementById("transactionID").value;
				var paypalAddress = document.getElementById("paypalAddressSell").value;

				// Making sure ammount sent is a number.

				if (isNaN(coinAmmountSent)) {
					alert("You must have a number for coin ammount sent.");
					console.log('%c Was not able to properly generate receipt. ', 'color: red;')
				} else {
					console.log('%c Was able to properly generate receipt using the coin ammount sent. Continuing checks. ', 'color: green;')
				}

				// Now it's time to get info from the transaction. This will be included in the receipt.

				fetch(checkTransactionID + transactionID + "&decrypt=1", {
					method: 'get'
				}).then(function(checkingTransactionID) {
					console.log('%c Checking transaction ID! ', 'color: red;');

					return checkingTransactionID.json();
				}).then(function(checkingTransactionToExplorer) {
					transaction = checkingTransactionToExplorer;
					console.log(transaction);

					console.log("Above is the raw transaction info.");

					if (transaction.vout[0].value != coinAmmountSent) {
						console.log(transaction.vout[0].value + " != " + coinAmmountSent);
						alert("Transaction failed! Transaction does not match ammount sent.");
						console.log('%c Oh no! transactionID did NOT match the ammount sent. ', 'color: red;');
					} else {
						console.log('%c Yes! Was able to veryify transaction with the blockchain. ', 'color: green;');
					}
				}).catch(function(errorInBlockchain) {
					console.log('%c Oh no! Either the blockchain or the explorer is not working. ', 'color: red;');
					alert("Error in the blockchain. Please wait a minute.");
				})

				document.getElementById("sellLogo").innerHTML = "Done! Blockchain verification done...";
				document.getElementById("sellLogo").innerHTML = "Invoicing store PayPal...";

			}
		</script>
	</head>

	<body onload="setPrices()">
		<!-- The actual interface. Probably alredy knew that. -->

		<img src="images/logo.png" class="garlicHeader" width="190px" height="190Spx">

		<h1 id="garlicPrice" class="garlicPrice">Getting current trading value...</h1>
		<h3 id="bankBalance" class="bankBalance">Gathering store balance...</h3>

		<div class="sellArea">
			<h2>Sell</h2>
			<p id="sellLogo">Read the sellers terms before selling!</p>

			<!-- Form Stuff! -->

			<h3>Ammount Sent:</h3>
			<input id="coinAmmountSent" type="text" name="ammountSent" placeholder="Ammount Sent">

			<h3>Transaction ID:</h3>
			<input id="transactionID" type="text" name="txid" placeholder="TX ID">

			<h3>Paypal Address:</h3>
			<input id="paypalAddressSell" type="text" name="paypalAddress" placeholder="Paypal Address">

			<button type="submit" onclick="sellClicked()">Sell Coins</button>
		</div>
		<div class="buyArea">
			<h2>Buy</h2>
			<p>Check the bank before buying!</p>

			<!-- Form Stuff! -->

			<h3>Ammount Wanted:</h3>
			<input id="coinAmmountWanted" type="text" name="ammountWanted" placeholder="Ammount Wanted">

			<h3>Wallet Address:</h3>
			<input id="walletAddress" type="text" name="wantedAddress" placeholder="Wallet Address">

			<h3>Paypal Address:</h3>
			<input id="paypalAddressBuy" type="text" name="paypalAddressBuy" placeholder="Paypal Address">

			<button type="submit" onclick="buyClicked()">Buy Coins</button>
		</div>

		<!-- Footer time! -->

		<div class="footer">bank: <strong>GXRH9QvpB2iEn1maY5QtVwfnyYcuhL3KK6</strong>
			<p><b>GarlicTrader is currently in beta! Things may change!<b></p>
		</div>
	</body>
</html>