<!DOCTYPE html>
<html>
	<head>
		<title>GarlicTrader</title>
		<link rel="stylesheet" href="resc/style.css">
		<link rel="icon" href="images/logo.png">

		<script>
			// Here is where I will set up all API's I need.

			var satoshiPrice;
			var bitcoinFloat;
			var priceInUSD;
			var bankBalance;

			const tradeSatoshiApi = "https://cors.io/?https://tradesatoshi.com/api/public/getmarkethistory?market=GRLC_BTC&count=1";
			const coindeskApi = "https://api.coindesk.com/v1/bpi/currentprice.json";
			const currentBankBalance = "https://cors.io/?http://explorer.grlc-bakery.fun/ext/getbalance/Gdhuz25VxxA5uLjF9S8u62KN4Gt8HjjcAs";

			fetch(tradeSatoshiApi, {
				method: 'get'
			}).then(function(satoshiResponse) {
				console.log('%c Was able to reach TradeSatoshi API ', 'color: green;') // Able to connect to Satoshi.

				// I am now going to get a response in JSON and work with it.

				return satoshiResponse.json(); // This is all this handles. Now for the next part.
			}).then(function(satoshiResponseJSON) {
				// Now our JSON response is a JS object. Now I can mess with it and set it's values.
				console.log(satoshiResponseJSON); // Log it.
				var stringSatoshiJSON = JSON.stringify(satoshiResponseJSON);
				console.log(stringSatoshiJSON);

				// For some reason I can't get stuff from this JSON array so I have to do it manually lol.

				var isolatedStringSetOne = stringSatoshiJSON.slice(stringSatoshiJSON.indexOf('price":') + 'price":'.length); // Isolate part of our string.
				
				satoshiPrice = isolatedStringSetOne.split(',')[0]
				console.log(satoshiPrice);

				// Yay! Price is now done.

			}).catch(function() {
				console.log('%c Error! Could not reach TradeSatoshi. ', 'color: red;');

				document.getElementById("garlicPrice").innerHTML = "Internal error. Please reload.";
			})

			// Time to get a conversion from BTC to USD.

			fetch(coindeskApi, {
				method: 'get'
			}).then(function(coindeskResponse) {
				console.log('%c Was able to reach Coindesk API ', 'color: green;')

				return coindeskResponse.json();

				setTimeout(coindeskResponseJSON)
			}).then(function(coindeskResponseJSON) {
				// Setting our variables,

				bitcoinFloat = coindeskResponseJSON.bpi.USD.rate_float;
				console.log("Current BTC price = " + bitcoinFloat + ".");
			})

			function setPrices() {

				// Set prices sets the BTC to USD price and also the bank prices.

				setTimeout(function() {
					var priceInUSD = satoshiPrice * bitcoinFloat;
					console.log(priceInUSD + " per coin.");

					priceInUSD = priceInUSD.toString(); // Because substring only works on strings.

					priceInUSD = priceInUSD.substring(0,4);
					document.getElementById("garlicPrice").innerHTML = "Current price = ~$" + priceInUSD + " per coin.";
				}, 2000)

				fetch(currentBankBalance, {
					method: 'get'
				}).then(function(gettingBankBalance) {
					console.log('%c Was able to access the explorer. ', 'color: green;')

					return gettingBankBalance.json();
				}).then(function(bankBalaceResponse) {
					// Set bank variables.

					bankBalance = bankBalaceResponse;
					console.log("Explorer says the bank has " + bankBalance + " coins.");

					document.getElementById("bankBalance").innerHTML = "Current store balance: " + bankBalance + " coins";

					console.log('%c GarlicTrader is all setup! Everything should work as described and all endpoints are working. ', 'color: green;')
				}).catch(function(catchBankBalance) {
					console.log('%c The Explorer API is not working. Please refresh or check API checkpoints. ', 'color: red;')

					document.getElementById("bankBalance").innerHTML = "Internal error. Please refresh.";
				})
			}
		</script>
	</head>

	<body onload="setPrices()">
		<!-- The actual interface. Probably alredy knew that. -->

		<img src="images/logo.png" class="garlicHeader" width="190px" height="190Spx">

		<h1 id="garlicPrice" class="garlicPrice">Getting current trading value...</h1>
		<h3 id="bankBalance" class="bankBalance">Gathering store balance...</h3>
	</body>
</html>